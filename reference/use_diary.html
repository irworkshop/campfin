<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Create a new template data diary — use_diary • campfin</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Create a new template data diary — use_diary" />
<meta property="og:description" content="Take the arguments supplied and put them into the appropriate places in a
new template diary. Write the new template diary in the supplied directory." />
<meta property="og:image" content="/logo.png" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">campfin</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.8.9201</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/normalize-geography.html">Normalize Geographic Variables</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/irworkshop/campfin/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Create a new template data diary</h1>
    <small class="dont-index">Source: <a href='https://github.com/irworkshop/campfin/blob/master/R/use-diary.R'><code>R/use-diary.R</code></a></small>
    <div class="hidden name"><code>use_diary.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Take the arguments supplied and put them into the appropriate places in a
new template diary. Write the new template diary in the supplied directory.</p>
    </div>

    <pre class="usage"><span class='fu'>use_diary</span><span class='op'>(</span><span class='va'>st</span>, <span class='va'>type</span>, <span class='va'>author</span>, auto <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>st</th>
      <td><p>The USPS state abbreviation.</p></td>
    </tr>
    <tr>
      <th>type</th>
      <td><p>The type of data, one of "contribs", "expends", or "lobby".</p></td>
    </tr>
    <tr>
      <th>author</th>
      <td><p>The author name of the new diary.</p></td>
    </tr>
    <tr>
      <th>auto</th>
      <td><p>If <code>TRUE</code>, file is created in the correct working directory.
If <code>FALSE</code>, a plain character string is returned. If a directory name, the
file is automatically written to that directory.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>The file path of new diary, invisibly.</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='fu'>use_diary</span><span class='op'>(</span><span class='st'>"VT"</span>, <span class='st'>"contribs"</span>, <span class='st'>"Kiernan Nicholls"</span>, <span class='cn'>FALSE</span><span class='op'>)</span>
</div><div class='output co'>#&gt;   [1] "---"                                                                             
#&gt;   [2] "title: \"Vermont Contributions\""                                                
#&gt;   [3] "author: \"Kiernan Nicholls\""                                                    
#&gt;   [4] "date: \"`r date()`\""                                                            
#&gt;   [5] "output:"                                                                         
#&gt;   [6] "  github_document: "                                                             
#&gt;   [7] "    df_print: tibble"                                                            
#&gt;   [8] "    toc: true"                                                                   
#&gt;   [9] "    toc_dept: 3"                                                                 
#&gt;  [10] "editor_options: "                                                                
#&gt;  [11] "  chunk_output_type: console"                                                    
#&gt;  [12] "---"                                                                             
#&gt;  [13] ""                                                                                
#&gt;  [14] "&lt;!-- Place comments regarding knitting here --&gt;"                                 
#&gt;  [15] ""                                                                                
#&gt;  [16] "```{r setup, include=FALSE, purl=FALSE}"                                         
#&gt;  [17] "library(knitr)"                                                                  
#&gt;  [18] "opts_chunk$set("                                                                 
#&gt;  [19] "  eval = TRUE,"                                                                  
#&gt;  [20] "  echo = TRUE,"                                                                  
#&gt;  [21] "  warning = FALSE,"                                                              
#&gt;  [22] "  message = FALSE,"                                                              
#&gt;  [23] "  error = FALSE,"                                                                
#&gt;  [24] "  collapse = TRUE,"                                                              
#&gt;  [25] "  comment = \"#&gt;\","                                                             
#&gt;  [26] "  fig.path = \"../plots/\","                                                     
#&gt;  [27] "  fig.width = 10,"                                                               
#&gt;  [28] "  dpi = 300"                                                                     
#&gt;  [29] ")"                                                                               
#&gt;  [30] "if (!interactive()) {"                                                           
#&gt;  [31] "  options(width = 120)"                                                          
#&gt;  [32] "  set.seed(5)"                                                                   
#&gt;  [33] "}"                                                                               
#&gt;  [34] "```"                                                                             
#&gt;  [35] ""                                                                                
#&gt;  [36] "```{r create-docs-dir, eval=FALSE, echo=FALSE, include=FALSE}"                   
#&gt;  [37] "doc_dir &lt;- fs::dir_create(here::here(\"vt\", \"contribs\", \"docs\"))"           
#&gt;  [38] "```"                                                                             
#&gt;  [39] ""                                                                                
#&gt;  [40] "## Project"                                                                      
#&gt;  [41] ""                                                                                
#&gt;  [42] "The Accountability Project is an effort to cut across data silos and give"       
#&gt;  [43] "journalists, policy professionals, activists, and the public at large a simple"  
#&gt;  [44] "way to search across huge volumes of public data about people and organizations."
#&gt;  [45] ""                                                                                
#&gt;  [46] "Our goal is to standardize public data on a few key fields by thinking of each"  
#&gt;  [47] "dataset row as a transaction. For each transaction there should be (at least) 3" 
#&gt;  [48] "variables:"                                                                      
#&gt;  [49] ""                                                                                
#&gt;  [50] "1. All **parties** to a transaction."                                            
#&gt;  [51] "2. The **date** of the transaction."                                             
#&gt;  [52] "3. The **amount** of money involved."                                            
#&gt;  [53] ""                                                                                
#&gt;  [54] "## Objectives"                                                                   
#&gt;  [55] ""                                                                                
#&gt;  [56] "This document describes the process used to complete the following objectives:"  
#&gt;  [57] ""                                                                                
#&gt;  [58] "1. How many records are in the database?"                                        
#&gt;  [59] "1. Check for entirely duplicated records."                                       
#&gt;  [60] "1. Check ranges of continuous variables."                                        
#&gt;  [61] "1. Is there anything blank or missing?"                                          
#&gt;  [62] "1. Check for consistency issues."                                                
#&gt;  [63] "1. Create a five-digit ZIP Code called `zip`."                                   
#&gt;  [64] "1. Create a `year` field from the transaction date."                             
#&gt;  [65] "1. Make sure there is data on both parties to a transaction."                    
#&gt;  [66] ""                                                                                
#&gt;  [67] "## Packages"                                                                     
#&gt;  [68] ""                                                                                
#&gt;  [69] "The following packages are needed to collect, manipulate, visualize, analyze,"   
#&gt;  [70] "and communicate these results. The `pacman` package will facilitate their"       
#&gt;  [71] "installation and attachment."                                                    
#&gt;  [72] ""                                                                                
#&gt;  [73] "```{r load-packages, message=FALSE, warning=FALSE, error=FALSE}"                 
#&gt;  [74] "if (!require(\"pacman\")) {"                                                     
#&gt;  [75] "  install.packages(\"pacman\")"                                                  
#&gt;  [76] "}"                                                                               
#&gt;  [77] "pacman::p_load("                                                                 
#&gt;  [78] "  tidyverse, # data manipulation"                                                
#&gt;  [79] "  lubridate, # datetime strings"                                                 
#&gt;  [80] "  gluedown, # printing markdown"                                                 
#&gt;  [81] "  janitor, # clean data frames"                                                  
#&gt;  [82] "  campfin, # custom irw tools"                                                   
#&gt;  [83] "  aws.s3, # aws cloud storage"                                                   
#&gt;  [84] "  refinr, # cluster &amp; merge"                                                     
#&gt;  [85] "  scales, # format strings"                                                      
#&gt;  [86] "  knitr, # knit documents"                                                       
#&gt;  [87] "  vroom, # fast reading"                                                         
#&gt;  [88] "  rvest, # scrape html"                                                          
#&gt;  [89] "  glue, # code strings"                                                          
#&gt;  [90] "  here, # project paths"                                                         
#&gt;  [91] "  httr, # http requests"                                                         
#&gt;  [92] "  fs # local storage "                                                           
#&gt;  [93] ")"                                                                               
#&gt;  [94] "```"                                                                             
#&gt;  [95] ""                                                                                
#&gt;  [96] "This diary was run using `campfin` version `r packageVersion(\"campfin\")`."     
#&gt;  [97] ""                                                                                
#&gt;  [98] "```{r campfin-version}"                                                          
#&gt;  [99] "packageVersion(\"campfin\")"                                                     
#&gt; [100] "```"                                                                             
#&gt; [101] ""                                                                                
#&gt; [102] "```{r package-options, echo=FALSE}"                                              
#&gt; [103] "options(options(knitr.kable.NA = \"\"))"                                         
#&gt; [104] "```"                                                                             
#&gt; [105] ""                                                                                
#&gt; [106] "This document should be run as part of the `R_tap` project, which lives as a"    
#&gt; [107] "sub-directory of the more general, language-agnostic"                            
#&gt; [108] "[`irworkshop/accountability_datacleaning`][tap] GitHub repository."              
#&gt; [109] ""                                                                                
#&gt; [110] "The `R_tap` project uses the [RStudio projects][rproj] feature and should be"    
#&gt; [111] "run as such. The project also uses the dynamic `here::here()` tool for file"     
#&gt; [112] "paths relative to _your_ machine."                                               
#&gt; [113] ""                                                                                
#&gt; [114] "```{r where-here}"                                                               
#&gt; [115] "# where does this document knit?"                                                
#&gt; [116] "here::i_am(\"vt/contribs/docs/vt_contribs_diary.Rmd\")"                          
#&gt; [117] "```"                                                                             
#&gt; [118] ""                                                                                
#&gt; [119] "[tap]: https://github.com/irworkshop/accountability_datacleaning"                
#&gt; [120] "[rproj]: https://support.rstudio.com/hc/en-us/articles/200526207-Using-Projects" 
#&gt; [121] ""                                                                                
#&gt; [122] "## Source"                                                                       
#&gt; [123] ""                                                                                
#&gt; [124] ""                                                                                
#&gt; [125] ""                                                                                
#&gt; [126] "## Download"                                                                     
#&gt; [127] ""                                                                                
#&gt; [128] "```{r raw-dir}"                                                                  
#&gt; [129] "raw_url &lt;- \"https://example.com/source_file.csv\""                              
#&gt; [130] "raw_dir &lt;- dir_create(here(\"vt\", \"contribs\", \"data\", \"raw\"))"            
#&gt; [131] "raw_csv &lt;- path(raw_dir, basename(raw_url))"                                     
#&gt; [132] "```"                                                                             
#&gt; [133] ""                                                                                
#&gt; [134] "```{r raw-download}"                                                             
#&gt; [135] "if (!file_exists(raw_csv)) {"                                                    
#&gt; [136] "  download.file(raw_url, raw_csv)"                                               
#&gt; [137] "}"                                                                               
#&gt; [138] "```"                                                                             
#&gt; [139] ""                                                                                
#&gt; [140] "## Read"                                                                         
#&gt; [141] ""                                                                                
#&gt; [142] "```{r raw-read}"                                                                 
#&gt; [143] "vtc &lt;- read_delim("                                                              
#&gt; [144] "  file = raw_csv,"                                                               
#&gt; [145] "  delim = \",\","                                                                
#&gt; [146] "  escape_backslash = FALSE,"                                                     
#&gt; [147] "  escape_double = FALSE,"                                                        
#&gt; [148] "  col_types = cols("                                                             
#&gt; [149] "    .default = col_character(),"                                                 
#&gt; [150] "    date = col_date_mdy(),"                                                      
#&gt; [151] "    amount = col_double()"                                                       
#&gt; [152] "  )"                                                                             
#&gt; [153] ")"                                                                               
#&gt; [154] "```"                                                                             
#&gt; [155] ""                                                                                
#&gt; [156] "```{r clean-names}"                                                              
#&gt; [157] "vtc &lt;- clean_names(vtc, case = \"snake\")"                                       
#&gt; [158] "```"                                                                             
#&gt; [159] ""                                                                                
#&gt; [160] "## Explore"                                                                      
#&gt; [161] ""                                                                                
#&gt; [162] "There are `r comma(nrow(vtc))` rows of `r ncol(vtc)` columns. Each record"       
#&gt; [163] "represents a single Contributions..."                                            
#&gt; [164] ""                                                                                
#&gt; [165] "```{r glimpse}"                                                                  
#&gt; [166] "glimpse(vtc)"                                                                    
#&gt; [167] "tail(vtc)"                                                                       
#&gt; [168] "```"                                                                             
#&gt; [169] ""                                                                                
#&gt; [170] "### Missing"                                                                     
#&gt; [171] ""                                                                                
#&gt; [172] "Columns vary in their degree of missing values."                                 
#&gt; [173] ""                                                                                
#&gt; [174] "```{r na-count}"                                                                 
#&gt; [175] "col_stats(vtc, count_na)"                                                        
#&gt; [176] "```"                                                                             
#&gt; [177] ""                                                                                
#&gt; [178] "We can flag any record missing a key variable needed to identify a transaction." 
#&gt; [179] ""                                                                                
#&gt; [180] "```{r na-flag}"                                                                  
#&gt; [181] "key_vars &lt;- c(\"date\", \"last_name\", \"amount\", \"committee_name\")"          
#&gt; [182] "vtc &lt;- flag_na(vtc, all_of(key_vars))"                                           
#&gt; [183] "sum(vtc$na_flag)"                                                                
#&gt; [184] "```"                                                                             
#&gt; [185] ""                                                                                
#&gt; [186] "```{r na-view}"                                                                  
#&gt; [187] "vtc %&gt;% "                                                                        
#&gt; [188] "  filter(na_flag) %&gt;% "                                                          
#&gt; [189] "  select(all_of(key_vars))"                                                      
#&gt; [190] "```"                                                                             
#&gt; [191] ""                                                                                
#&gt; [192] "### Duplicates"                                                                  
#&gt; [193] ""                                                                                
#&gt; [194] "We can also flag any record completely duplicated across every column."          
#&gt; [195] ""                                                                                
#&gt; [196] "```{r dupe-flag}"                                                                
#&gt; [197] "vtc &lt;- flag_dupes(vtc, -id)"                                                     
#&gt; [198] "sum(vtc$dupe_flag)"                                                              
#&gt; [199] "```"                                                                             
#&gt; [200] ""                                                                                
#&gt; [201] "```{r dupe-view}"                                                                
#&gt; [202] "vtc %&gt;% "                                                                        
#&gt; [203] "  filter(dupe_flag) %&gt;% "                                                        
#&gt; [204] "  select(all_of(key_vars)) %&gt;% "                                                 
#&gt; [205] "  arrange(date)"                                                                 
#&gt; [206] "```"                                                                             
#&gt; [207] ""                                                                                
#&gt; [208] "### Categorical"                                                                 
#&gt; [209] ""                                                                                
#&gt; [210] "```{r distinct-count}"                                                           
#&gt; [211] "col_stats(vtc, n_distinct)"                                                      
#&gt; [212] "```"                                                                             
#&gt; [213] ""                                                                                
#&gt; [214] "```{r distinct-plots, echo=FALSE, fig.height=3}"                                 
#&gt; [215] "explore_plot(vtc, type)"                                                         
#&gt; [216] "```"                                                                             
#&gt; [217] ""                                                                                
#&gt; [218] "### Amounts"                                                                     
#&gt; [219] ""                                                                                
#&gt; [220] "```{r amount-round}"                                                             
#&gt; [221] "# fix floating point precision"                                                  
#&gt; [222] "vtc$amount &lt;- round(vtc$amount, digits = 2)"                                     
#&gt; [223] "```"                                                                             
#&gt; [224] ""                                                                                
#&gt; [225] "```{r amount-summary}"                                                           
#&gt; [226] "summary(vtc$amount)"                                                             
#&gt; [227] "mean(vtc$amount &lt;= 0)"                                                           
#&gt; [228] "```"                                                                             
#&gt; [229] ""                                                                                
#&gt; [230] "These are the records with the minimum and maximum amounts."                     
#&gt; [231] ""                                                                                
#&gt; [232] "```{r amount-minmax}"                                                            
#&gt; [233] "glimpse(vtc[c(which.max(vtc$amount), which.min(vtc$amount)), ])"                 
#&gt; [234] "```"                                                                             
#&gt; [235] ""                                                                                
#&gt; [236] "The distribution of amount values are typically log-normal."                     
#&gt; [237] ""                                                                                
#&gt; [238] "```{r hist-amount, echo=FALSE}"                                                  
#&gt; [239] "vtc %&gt;%"                                                                         
#&gt; [240] "  ggplot(aes(amount)) +"                                                         
#&gt; [241] "  geom_histogram(fill = dark2[\"purple\"]) +"                                    
#&gt; [242] "  scale_y_continuous(labels = comma) +"                                          
#&gt; [243] "  scale_x_continuous("                                                           
#&gt; [244] "    breaks = c(1 %o% 10^(0:6)),"                                                 
#&gt; [245] "    labels = dollar,"                                                            
#&gt; [246] "    trans = \"log10\""                                                           
#&gt; [247] "  ) +"                                                                           
#&gt; [248] "  labs("                                                                         
#&gt; [249] "    title = \"Vermont Contributions Amount Distribution\","                      
#&gt; [250] "    caption = \"Source: {source}\","                                             
#&gt; [251] "    x = \"Amount\","                                                             
#&gt; [252] "    y = \"Count\""                                                               
#&gt; [253] "  )"                                                                             
#&gt; [254] "```"                                                                             
#&gt; [255] ""                                                                                
#&gt; [256] "### Dates"                                                                       
#&gt; [257] ""                                                                                
#&gt; [258] "We can add the calendar year from `date` with `lubridate::year()`"               
#&gt; [259] ""                                                                                
#&gt; [260] "```{r date-year}"                                                                
#&gt; [261] "vtc &lt;- mutate(vtc, year = year(date))"                                           
#&gt; [262] "```"                                                                             
#&gt; [263] ""                                                                                
#&gt; [264] "```{r date-range}"                                                               
#&gt; [265] "min(vtc$date)"                                                                   
#&gt; [266] "sum(vtc$year &lt; 2000)"                                                            
#&gt; [267] "max(vtc$date)"                                                                   
#&gt; [268] "sum(vtc$date &gt; today())"                                                         
#&gt; [269] "```"                                                                             
#&gt; [270] ""                                                                                
#&gt; [271] "It's common to see an increase in the number of contributins in elections years."
#&gt; [272] ""                                                                                
#&gt; [273] "```{r bar-year, echo=FALSE}"                                                     
#&gt; [274] "vtc %&gt;% "                                                                        
#&gt; [275] "  count(year) %&gt;% "                                                              
#&gt; [276] "  mutate(even = is_even(year)) %&gt;% "                                             
#&gt; [277] "  ggplot(aes(x = year, y = n)) +"                                                
#&gt; [278] "  geom_col(aes(fill = even)) + "                                                 
#&gt; [279] "  scale_fill_brewer(palette = \"Dark2\") +"                                      
#&gt; [280] "  scale_y_continuous(labels = comma) +"                                          
#&gt; [281] "  scale_x_continuous(breaks = seq(2000, 2020, by = 2)) +"                        
#&gt; [282] "  theme(legend.position = \"bottom\") +"                                         
#&gt; [283] "  labs("                                                                         
#&gt; [284] "    title = \"Vermont Contributions by Year\","                                  
#&gt; [285] "    caption = \"Source: {source}\","                                             
#&gt; [286] "    fill = \"Election Year\","                                                   
#&gt; [287] "    x = \"Year Made\","                                                          
#&gt; [288] "    y = \"Count\""                                                               
#&gt; [289] "  )"                                                                             
#&gt; [290] "```"                                                                             
#&gt; [291] ""                                                                                
#&gt; [292] "## Wrangle"                                                                      
#&gt; [293] ""                                                                                
#&gt; [294] "To improve the searchability of the database, we will perform some consistent,"  
#&gt; [295] "confident string normalization. For geographic variables like city names and"    
#&gt; [296] "ZIP codes, the corresponding `campfin::normal_*()` functions are tailor made to "
#&gt; [297] "facilitate this process."                                                        
#&gt; [298] ""                                                                                
#&gt; [299] "### Address"                                                                     
#&gt; [300] ""                                                                                
#&gt; [301] "For the street `addresss` variable, the `campfin::normal_address()` function"    
#&gt; [302] "will force consistence case, remove punctuation, and abbreviate official "       
#&gt; [303] "USPS suffixes."                                                                  
#&gt; [304] ""                                                                                
#&gt; [305] "```{r address-norm}"                                                             
#&gt; [306] "addr_norm &lt;- vtc %&gt;% "                                                           
#&gt; [307] "  distinct(address1, address2) %&gt;% "                                             
#&gt; [308] "  unite("                                                                        
#&gt; [309] "    col = address_full,"                                                         
#&gt; [310] "    starts_with(\"address\"),"                                                   
#&gt; [311] "    sep = \" \","                                                                
#&gt; [312] "    remove = FALSE,"                                                             
#&gt; [313] "    na.rm = TRUE"                                                                
#&gt; [314] "  ) %&gt;% "                                                                        
#&gt; [315] "  mutate("                                                                       
#&gt; [316] "    address_norm = normal_address("                                              
#&gt; [317] "      address = address_full,"                                                   
#&gt; [318] "      abbs = usps_street,"                                                       
#&gt; [319] "      na_rep = TRUE"                                                             
#&gt; [320] "    )"                                                                           
#&gt; [321] "  ) %&gt;% "                                                                        
#&gt; [322] "  select(-address_full)"                                                         
#&gt; [323] "```"                                                                             
#&gt; [324] ""                                                                                
#&gt; [325] "```{r address-view}"                                                             
#&gt; [326] "addr_norm"                                                                       
#&gt; [327] "```"                                                                             
#&gt; [328] ""                                                                                
#&gt; [329] "```{r address-join}"                                                             
#&gt; [330] "vtc &lt;- left_join(vtc, addr_norm, by = c(\"address1\", \"address2\"))"            
#&gt; [331] "```"                                                                             
#&gt; [332] ""                                                                                
#&gt; [333] "### ZIP"                                                                         
#&gt; [334] ""                                                                                
#&gt; [335] "For ZIP codes, the `campfin::normal_zip()` function will attempt to create"      
#&gt; [336] "valid _five_ digit codes by removing the ZIP+4 suffix and returning leading"     
#&gt; [337] "zeroes dropped by other programs like Microsoft Excel."                          
#&gt; [338] ""                                                                                
#&gt; [339] "```{r zip-norm}"                                                                 
#&gt; [340] "vtc &lt;- vtc %&gt;% "                                                                 
#&gt; [341] "  mutate("                                                                       
#&gt; [342] "    zip_norm = normal_zip("                                                      
#&gt; [343] "      zip = zip,"                                                                
#&gt; [344] "      na_rep = TRUE"                                                             
#&gt; [345] "    )"                                                                           
#&gt; [346] "  )"                                                                             
#&gt; [347] "```"                                                                             
#&gt; [348] ""                                                                                
#&gt; [349] "```{r zip-progress}"                                                             
#&gt; [350] "progress_table("                                                                 
#&gt; [351] "  vtc$zip,"                                                                      
#&gt; [352] "  vtc$zip_norm,"                                                                 
#&gt; [353] "  compare = valid_zip"                                                           
#&gt; [354] ")"                                                                               
#&gt; [355] "```"                                                                             
#&gt; [356] ""                                                                                
#&gt; [357] "### State"                                                                       
#&gt; [358] ""                                                                                
#&gt; [359] "Valid two digit state abbreviations can be made using the "                      
#&gt; [360] "`campfin::normal_state()` function."                                             
#&gt; [361] ""                                                                                
#&gt; [362] "```{r state-norm}"                                                               
#&gt; [363] "vtc &lt;- vtc %&gt;% "                                                                 
#&gt; [364] "  mutate("                                                                       
#&gt; [365] "    state_norm = normal_state("                                                  
#&gt; [366] "      state = state,"                                                            
#&gt; [367] "      abbreviate = TRUE,"                                                        
#&gt; [368] "      na_rep = TRUE,"                                                            
#&gt; [369] "      valid = valid_state"                                                       
#&gt; [370] "    )"                                                                           
#&gt; [371] "  )"                                                                             
#&gt; [372] "```"                                                                             
#&gt; [373] ""                                                                                
#&gt; [374] "```{r state-view}"                                                               
#&gt; [375] "vtc %&gt;% "                                                                        
#&gt; [376] "  filter(state != state_norm) %&gt;% "                                              
#&gt; [377] "  count(state, state_norm, sort = TRUE)"                                         
#&gt; [378] "```"                                                                             
#&gt; [379] ""                                                                                
#&gt; [380] "```{r state-progress}"                                                           
#&gt; [381] "progress_table("                                                                 
#&gt; [382] "  vtc$state,"                                                                    
#&gt; [383] "  vtc$state_norm,"                                                               
#&gt; [384] "  compare = valid_state"                                                         
#&gt; [385] ")"                                                                               
#&gt; [386] "```"                                                                             
#&gt; [387] ""                                                                                
#&gt; [388] "### City"                                                                        
#&gt; [389] ""                                                                                
#&gt; [390] "Cities are the most difficult geographic variable to normalize, simply due to"   
#&gt; [391] "the wide variety of valid cities and formats."                                   
#&gt; [392] ""                                                                                
#&gt; [393] "#### Normal"                                                                     
#&gt; [394] ""                                                                                
#&gt; [395] "The `campfin::normal_city()` function is a good start, again converting case,"   
#&gt; [396] "removing punctuation, but _expanding_ USPS abbreviations. We can also remove"    
#&gt; [397] "`invalid_city` values."                                                          
#&gt; [398] ""                                                                                
#&gt; [399] "```{r city-norm}"                                                                
#&gt; [400] "norm_city &lt;- vtc %&gt;% "                                                           
#&gt; [401] "  distinct(city, state_norm, zip_norm) %&gt;% "                                     
#&gt; [402] "  mutate("                                                                       
#&gt; [403] "    city_norm = normal_city("                                                    
#&gt; [404] "      city = city, "                                                             
#&gt; [405] "      abbs = usps_city,"                                                         
#&gt; [406] "      states = c(\"VT\", \"DC\", \"VERMONT\"),"                                  
#&gt; [407] "      na = invalid_city,"                                                        
#&gt; [408] "      na_rep = TRUE"                                                             
#&gt; [409] "    )"                                                                           
#&gt; [410] "  )"                                                                             
#&gt; [411] "```"                                                                             
#&gt; [412] ""                                                                                
#&gt; [413] "#### Swap"                                                                       
#&gt; [414] ""                                                                                
#&gt; [415] "We can further improve normalization by comparing our normalized value"          
#&gt; [416] "against the _expected_ value for that record's state abbreviation and ZIP code." 
#&gt; [417] "If the normalized value is either an abbreviation for or very similar to the"    
#&gt; [418] "expected value, we can confidently swap those two."                              
#&gt; [419] ""                                                                                
#&gt; [420] "```{r city-swap}"                                                                
#&gt; [421] "norm_city &lt;- norm_city %&gt;% "                                                     
#&gt; [422] "  rename(city_raw = city) %&gt;% "                                                  
#&gt; [423] "  left_join("                                                                    
#&gt; [424] "    y = zipcodes,"                                                               
#&gt; [425] "    by = c("                                                                     
#&gt; [426] "      \"state_norm\" = \"state\","                                               
#&gt; [427] "      \"zip_norm\" = \"zip\""                                                    
#&gt; [428] "    )"                                                                           
#&gt; [429] "  ) %&gt;% "                                                                        
#&gt; [430] "  rename(city_match = city) %&gt;% "                                                
#&gt; [431] "  mutate("                                                                       
#&gt; [432] "    match_abb = is_abbrev(city_norm, city_match),"                               
#&gt; [433] "    match_dist = str_dist(city_norm, city_match),"                               
#&gt; [434] "    city_swap = if_else("                                                        
#&gt; [435] "      condition = !is.na(match_dist) &amp; (match_abb | match_dist == 1),"           
#&gt; [436] "      true = city_match,"                                                        
#&gt; [437] "      false = city_norm"                                                         
#&gt; [438] "    )"                                                                           
#&gt; [439] "  ) %&gt;% "                                                                        
#&gt; [440] "  select("                                                                       
#&gt; [441] "    -city_match,"                                                                
#&gt; [442] "    -match_dist,"                                                                
#&gt; [443] "    -match_abb"                                                                  
#&gt; [444] "  )"                                                                             
#&gt; [445] "```"                                                                             
#&gt; [446] ""                                                                                
#&gt; [447] "```{r city-rejoin}"                                                              
#&gt; [448] "vtc &lt;- left_join("                                                               
#&gt; [449] "  x = vtc,"                                                                      
#&gt; [450] "  y = norm_city,"                                                                
#&gt; [451] "  by = c("                                                                       
#&gt; [452] "    \"city\" = \"city_raw\", "                                                   
#&gt; [453] "    \"state_norm\", "                                                            
#&gt; [454] "    \"zip_norm\""                                                                
#&gt; [455] "  )"                                                                             
#&gt; [456] ")"                                                                               
#&gt; [457] "```"                                                                             
#&gt; [458] ""                                                                                
#&gt; [459] "#### Refine"                                                                     
#&gt; [460] ""                                                                                
#&gt; [461] "The [OpenRefine][or] algorithms can be used to group similar strings and replace"
#&gt; [462] "the less common versions with their most common counterpart. This can greatly"   
#&gt; [463] "reduce inconsistency, but with low confidence; we will only keep any refined"    
#&gt; [464] "strings that have a valid city/state/zip combination."                           
#&gt; [465] ""                                                                                
#&gt; [466] "[or]: https://openrefine.org/"                                                   
#&gt; [467] ""                                                                                
#&gt; [468] "```{r city-refine}"                                                              
#&gt; [469] "good_refine &lt;- vtc %&gt;% "                                                         
#&gt; [470] "  mutate("                                                                       
#&gt; [471] "    city_refine = city_swap %&gt;% "                                                
#&gt; [472] "      key_collision_merge() %&gt;% "                                                
#&gt; [473] "      n_gram_merge(numgram = 1)"                                                 
#&gt; [474] "  ) %&gt;% "                                                                        
#&gt; [475] "  filter(city_refine != city_swap) %&gt;% "                                         
#&gt; [476] "  inner_join("                                                                   
#&gt; [477] "    y = zipcodes,"                                                               
#&gt; [478] "    by = c("                                                                     
#&gt; [479] "      \"city_refine\" = \"city\","                                               
#&gt; [480] "      \"state_norm\" = \"state\","                                               
#&gt; [481] "      \"zip_norm\" = \"zip\""                                                    
#&gt; [482] "    )"                                                                           
#&gt; [483] "  )"                                                                             
#&gt; [484] "```"                                                                             
#&gt; [485] ""                                                                                
#&gt; [486] "```{r city-count, echo=FALSE}"                                                   
#&gt; [487] "good_refine %&gt;%"                                                                 
#&gt; [488] "  count("                                                                        
#&gt; [489] "    state_norm, "                                                                
#&gt; [490] "    zip_norm, "                                                                  
#&gt; [491] "    city_swap, "                                                                 
#&gt; [492] "    city_refine,"                                                                
#&gt; [493] "    sort = TRUE"                                                                 
#&gt; [494] "  )"                                                                             
#&gt; [495] "```"                                                                             
#&gt; [496] ""                                                                                
#&gt; [497] "Then we can join the refined values back to the database."                       
#&gt; [498] ""                                                                                
#&gt; [499] "```{r city-join}"                                                                
#&gt; [500] "vtc &lt;- vtc %&gt;% "                                                                 
#&gt; [501] "  left_join(good_refine, by = names(.)) %&gt;% "                                    
#&gt; [502] "  mutate(city_refine = coalesce(city_refine, city_swap))"                        
#&gt; [503] "```"                                                                             
#&gt; [504] ""                                                                                
#&gt; [505] "#### Progress"                                                                   
#&gt; [506] ""                                                                                
#&gt; [507] "Our goal for normalization was to increase the proportion of city values known"  
#&gt; [508] "to be valid and reduce the total distinct values by correcting misspellings."    
#&gt; [509] ""                                                                                
#&gt; [510] "```{r city-progress, echo=FALSE}"                                                
#&gt; [511] "many_city &lt;- c(valid_city, extra_city)"                                          
#&gt; [512] "progress &lt;- progress_table("                                                     
#&gt; [513] "  str_to_upper(vtc$city),"                                                       
#&gt; [514] "  vtc$city_norm,"                                                                
#&gt; [515] "  vtc$city_swap,"                                                                
#&gt; [516] "  vtc$city_refine,"                                                              
#&gt; [517] "  compare = many_city"                                                           
#&gt; [518] ") %&gt;% mutate(stage = as_factor(stage))"                                          
#&gt; [519] "progress %&gt;% "                                                                   
#&gt; [520] "    mutate(across(stage, md_code)) %&gt;% "                                         
#&gt; [521] "    kable(digits = 3)"                                                           
#&gt; [522] "```"                                                                             
#&gt; [523] ""                                                                                
#&gt; [524] "You can see how the percentage of valid values increased with each stage."       
#&gt; [525] ""                                                                                
#&gt; [526] "```{r bar-progress, echo=FALSE}"                                                 
#&gt; [527] "raw_in &lt;- percent(prop_in(vtc$city, valid_city))"                                
#&gt; [528] "progress %&gt;% "                                                                   
#&gt; [529] "  ggplot(aes(x = stage, y = prop_in)) +"                                         
#&gt; [530] "  geom_hline(yintercept = 0.99) +"                                               
#&gt; [531] "  geom_col(fill = dark2[\"purple\"]) +"                                          
#&gt; [532] "  coord_cartesian(ylim = c(0.75, 1)) +"                                          
#&gt; [533] "  scale_y_continuous(labels = percent) +"                                        
#&gt; [534] "  labs("                                                                         
#&gt; [535] "    title = \"Vermont City Normalization Progress\","                            
#&gt; [536] "    subtitle = glue(\"Raw at {raw_in} before conversion to uppercase\"),"        
#&gt; [537] "    x = \"Stage\","                                                              
#&gt; [538] "    y = \"Percent Valid\""                                                       
#&gt; [539] "  )"                                                                             
#&gt; [540] "```"                                                                             
#&gt; [541] ""                                                                                
#&gt; [542] "More importantly, the number of distinct values decreased each stage. We were"   
#&gt; [543] "able to confidently change many distinct invalid values to their valid"          
#&gt; [544] "equivalent."                                                                     
#&gt; [545] ""                                                                                
#&gt; [546] "```{r bar-distinct, echo=FALSE}"                                                 
#&gt; [547] "progress %&gt;% "                                                                   
#&gt; [548] "  select("                                                                       
#&gt; [549] "    stage, "                                                                     
#&gt; [550] "    all = n_distinct,"                                                           
#&gt; [551] "    bad = n_diff"                                                                
#&gt; [552] "  ) %&gt;% "                                                                        
#&gt; [553] "  mutate(good = all - bad) %&gt;% "                                                 
#&gt; [554] "  pivot_longer(c(\"good\", \"bad\")) %&gt;% "                                       
#&gt; [555] "  mutate(name = name == \"good\") %&gt;% "                                          
#&gt; [556] "  ggplot(aes(x = stage, y = value)) +"                                           
#&gt; [557] "  geom_col(aes(fill = name)) +"                                                  
#&gt; [558] "  scale_fill_brewer(palette = \"Dark2\", direction = -1) +"                      
#&gt; [559] "  scale_y_continuous(labels = comma) +"                                          
#&gt; [560] "  theme(legend.position = \"bottom\") +"                                         
#&gt; [561] "  labs("                                                                         
#&gt; [562] "    title = \"Vermont City Normalization Progress\","                            
#&gt; [563] "    subtitle = \"Distinct values, valid and invalid\","                          
#&gt; [564] "    x = \"Stage\","                                                              
#&gt; [565] "    y = \"Distinct Values\","                                                    
#&gt; [566] "    fill = \"Valid\""                                                            
#&gt; [567] "  )"                                                                             
#&gt; [568] "```"                                                                             
#&gt; [569] ""                                                                                
#&gt; [570] "Before exporting, we can remove the intermediary normalization columns and"      
#&gt; [571] "rename all added variables with the `_clean` suffix."                            
#&gt; [572] ""                                                                                
#&gt; [573] "```{r clean-select}"                                                             
#&gt; [574] "vtc &lt;- vtc %&gt;% "                                                                 
#&gt; [575] "  select("                                                                       
#&gt; [576] "    -city_norm,"                                                                 
#&gt; [577] "    -city_swap,"                                                                 
#&gt; [578] "    city_clean = city_refine"                                                    
#&gt; [579] "  ) %&gt;% "                                                                        
#&gt; [580] "  rename_all(~str_replace(., \"_norm\", \"_clean\")) %&gt;% "                       
#&gt; [581] "  rename_all(~str_remove(., \"_raw\")) %&gt;% "                                     
#&gt; [582] "  relocate(address_clean, city_clean, state_clean, .before = zip_clean)"         
#&gt; [583] "```"                                                                             
#&gt; [584] ""                                                                                
#&gt; [585] "## Conclude"                                                                     
#&gt; [586] ""                                                                                
#&gt; [587] "```{r clean-glimpse}"                                                            
#&gt; [588] "glimpse(sample_n(vtc, 1000))"                                                    
#&gt; [589] "```"                                                                             
#&gt; [590] ""                                                                                
#&gt; [591] "1. There are `r comma(nrow(vtc))` records in the database."                      
#&gt; [592] "1. There are `r comma(sum(vtc$dupe_flag))` duplicate records in the database."   
#&gt; [593] "1. The range and distribution of `amount` and `date` seem reasonable."           
#&gt; [594] "1. There are `r comma(sum(vtc$na_flag))` records missing key variables."         
#&gt; [595] "1. Consistency in geographic data has been improved with `campfin::normal_*()`." 
#&gt; [596] "1. The 4-digit `year` variable has been created with `lubridate::year()`."       
#&gt; [597] ""                                                                                
#&gt; [598] "## Export"                                                                       
#&gt; [599] ""                                                                                
#&gt; [600] "Now the file can be saved on disk for upload to the Accountability server. We"   
#&gt; [601] "will name the object using a date range of the records included."                
#&gt; [602] ""                                                                                
#&gt; [603] "```{r clean-timestamp}"                                                          
#&gt; [604] "min_dt &lt;- str_remove_all(min(vtc$date), \"-\")"                                  
#&gt; [605] "max_dt &lt;- str_remove_all(max(vtc$date), \"-\")"                                  
#&gt; [606] "csv_ts &lt;- paste(min_dt, max_dt, sep = \"-\")"                                    
#&gt; [607] "```"                                                                             
#&gt; [608] ""                                                                                
#&gt; [609] "```{r clean-dir}"                                                                
#&gt; [610] "clean_dir &lt;- dir_create(here(\"vt\", \"contribs\", \"data\", \"clean\"))"        
#&gt; [611] "clean_csv &lt;- path(clean_dir, \"vt_contribs_{csv_ts}.csv\")"                      
#&gt; [612] "write_csv(vtc, clean_csv, na = \"\")"                                            
#&gt; [613] "(clean_size &lt;- file_size(clean_path))"                                           
#&gt; [614] "```"                                                                             
#&gt; [615] ""                                                                                
#&gt; [616] "## Upload"                                                                       
#&gt; [617] ""                                                                                
#&gt; [618] "We can use the `aws.s3::put_object()` to upload the text file to the IRW server."
#&gt; [619] ""                                                                                
#&gt; [620] "```{r aws-upload, eval=FALSE}"                                                   
#&gt; [621] "aws_key &lt;- path(\"csv\", basename(clean_csv))"                                   
#&gt; [622] "if (!object_exists(aws_csv, \"publicaccountability\")) {"                        
#&gt; [623] "  put_object("                                                                   
#&gt; [624] "    file = clean_csv,"                                                           
#&gt; [625] "    object = aws_key, "                                                          
#&gt; [626] "    bucket = \"publicaccountability\","                                          
#&gt; [627] "    acl = \"public-read\","                                                      
#&gt; [628] "    show_progress = TRUE,"                                                       
#&gt; [629] "    multipart = TRUE"                                                            
#&gt; [630] "  )"                                                                             
#&gt; [631] "}"                                                                               
#&gt; [632] "aws_head &lt;- head_object(aws_csv, \"publicaccountability\")"                      
#&gt; [633] "(aws_size &lt;- as_fs_bytes(attr(aws_head, \"content-length\")))"                   
#&gt; [634] "unname(aws_size == clean_size)"                                                  
#&gt; [635] "```"                                                                             
#&gt; [636] ""                                                                                
#&gt; [637] "## Dictionary"                                                                   
#&gt; [638] ""                                                                                
#&gt; [639] "The following table describes the variables in our final exported file:"         
#&gt; [640] ""                                                                                
#&gt; [641] "```{r dict-make, echo=FALSE}"                                                    
#&gt; [642] "dict_raw &lt;- tibble("                                                             
#&gt; [643] "  var = md_code(names(vtc)),"                                                    
#&gt; [644] "  type = md_code(map_chr(vtc, typeof)),"                                         
#&gt; [645] "  def = c("                                                                      
#&gt; [646] "    \"\""                                                                        
#&gt; [647] "  )"                                                                             
#&gt; [648] ")"                                                                               
#&gt; [649] "```"                                                                             
#&gt; [650] ""                                                                                
#&gt; [651] "```{r dict-md, echo=FALSE}"                                                      
#&gt; [652] "(dict_md &lt;- kable("                                                              
#&gt; [653] "  x = dict_raw,"                                                                 
#&gt; [654] "  format = \"markdown\","                                                        
#&gt; [655] "  col.names = c(\"Column\", \"Type\", \"Definition\")"                           
#&gt; [656] "))"                                                                              
#&gt; [657] "```"                                                                             </div><div class='input'><span class='fu'>use_diary</span><span class='op'>(</span><span class='st'>"VT"</span>, <span class='st'>"contribs"</span>, <span class='st'>"Kiernan Nicholls"</span>, <span class='fu'><a href='https://rdrr.io/r/base/tempfile.html'>tempdir</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'>/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpWhGwu7/vt_contribs_diary.Rmd was created</span></div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Kiernan Nicholls, Yanqi Xu.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


