<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Create a new template data diary — use_diary • campfin</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Create a new template data diary — use_diary"><meta property="og:description" content="Take the arguments supplied and put them into the appropriate places in a
new template diary. Write the new template diary in the supplied directory."><meta property="og:image" content="/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">campfin</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.11</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/normalize-geography.html">Normalize Geographic Variables</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/irworkshop/campfin/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Create a new template data diary</h1>
    <small class="dont-index">Source: <a href="https://github.com/irworkshop/campfin/blob/HEAD/R/use-diary.R" class="external-link"><code>R/use-diary.R</code></a></small>
    <div class="hidden name"><code>use_diary.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Take the arguments supplied and put them into the appropriate places in a
new template diary. Write the new template diary in the supplied directory.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">use_diary</span><span class="op">(</span></span>
<span>  <span class="va">st</span>,</span>
<span>  <span class="va">type</span>,</span>
<span>  <span class="va">author</span>,</span>
<span>  path <span class="op">=</span> <span class="st">"state/{st}/{type}/docs/{st}_{type}_diary.Rmd"</span>,</span>
<span>  auto <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>st</dt>
<dd><p>The USPS state abbreviation. State data only, no federal agencies.</p></dd>


<dt>type</dt>
<dd><p>The type of data, one of "contribs", "expends", "lobby",
"contracts", "salary", or "voters".</p></dd>


<dt>author</dt>
<dd><p>The author name of the new diary.</p></dd>


<dt>path</dt>
<dd><p>The file path, relative to your working directory, where the
diary file will be created. If you use <code>NA</code>, then the lines of the diary
will be returned as a character vector. If you specify a character string
file path that contains directories that do not exist then they will be
created. By default, the path creates the diary in a directory that is
expected by the <a href="https://github.com/irworkshop/accountability_datacleaning" class="external-link">Accountability Project GitHub repository</a>.</p></dd>


<dt>auto</dt>
<dd><p>Must be set to <code>TRUE</code> for the diary to be created and opened.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>The file path of new diary, invisibly.</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu">use_diary</span><span class="op">(</span><span class="st">"VT"</span>, <span class="st">"contribs"</span>, <span class="st">"Kiernan Nicholls"</span>, <span class="cn">NA</span>, auto <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [1] "---"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [2] "title: \"Vermont Contributions\""                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [3] "author: \"Kiernan Nicholls\""                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [4] "date: \"`r date()`\""                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [5] "output:"                                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [6] "  github_document: "                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [7] "    df_print: tibble"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [8] "    toc: true"                                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [9] "    toc_dept: 3"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [10] "editor_options: "                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [11] "  chunk_output_type: console"                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [12] "---"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [13] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [14] "&lt;!-- Place comments regarding knitting here --&gt;"                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [15] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [16] "```{r setup, include=FALSE, purl=FALSE}"                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [17] "library(knitr)"                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [18] "opts_chunk$set("                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [19] "  eval = TRUE,"                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [20] "  echo = TRUE,"                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [21] "  warning = FALSE,"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [22] "  message = FALSE,"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [23] "  error = FALSE,"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [24] "  collapse = TRUE,"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [25] "  comment = \"#&gt;\","                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [26] "  fig.path = \"../plots/\","                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [27] "  fig.width = 10,"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [28] "  dpi = 300"                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [29] ")"                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [30] "if (!interactive()) {"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [31] "  options(width = 120)"                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [32] "  set.seed(5)"                                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [33] "}"                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [34] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [35] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [36] "```{r create-docs-dir, eval=FALSE, echo=FALSE, include=FALSE}"                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [37] "doc_dir &lt;- fs::dir_create(here::here(\"state\", \"vt\", \"contribs\", \"docs\"))"   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [38] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [39] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [40] "## Project"                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [41] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [42] "The Accountability Project is an effort to cut across data silos and give"          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [43] "journalists, policy professionals, activists, and the public at large a simple"     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [44] "way to search across huge volumes of public data about people and organizations."   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [45] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [46] "Our goal is to standardize public data on a few key fields by thinking of each"     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [47] "dataset row as a transaction. For each transaction there should be (at least) 3"    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [48] "variables:"                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [49] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [50] "1. All **parties** to a transaction."                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [51] "2. The **date** of the transaction."                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [52] "3. The **amount** of money involved."                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [53] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [54] "## Objectives"                                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [55] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [56] "This document describes the process used to complete the following objectives:"     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [57] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [58] "1. How many records are in the database?"                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [59] "1. Check for entirely duplicated records."                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [60] "1. Check ranges of continuous variables."                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [61] "1. Is there anything blank or missing?"                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [62] "1. Check for consistency issues."                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [63] "1. Create a five-digit ZIP Code called `zip`."                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [64] "1. Create a `year` field from the transaction date."                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [65] "1. Make sure there is data on both parties to a transaction."                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [66] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [67] "## Packages"                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [68] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [69] "The following packages are needed to collect, manipulate, visualize, analyze,"      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [70] "and communicate these results. The `pacman` package will facilitate their"          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [71] "installation and attachment."                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [72] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [73] "```{r load-packages, message=FALSE, warning=FALSE, error=FALSE}"                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [74] "if (!require(\"pacman\")) {"                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [75] "  install.packages(\"pacman\")"                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [76] "}"                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [77] "pacman::p_load("                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [78] "  tidyverse, # data manipulation"                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [79] "  lubridate, # datetime strings"                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [80] "  gluedown, # printing markdown"                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [81] "  jsonlite, # read json files"                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [82] "  janitor, # clean data frames"                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [83] "  campfin, # custom irw tools"                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [84] "  aws.s3, # aws cloud storage"                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [85] "  readxl, # read excel files"                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [86] "  refinr, # cluster &amp; merge"                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [87] "  scales, # format strings"                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [88] "  knitr, # knit documents"                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [89] "  rvest, # scrape html"                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [90] "  glue, # code strings"                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [91] "  here, # project paths"                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [92] "  httr, # http requests"                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [93] "  fs # local storage "                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [94] ")"                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [95] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [96] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [97] "This diary was run using `campfin` version `r packageVersion(\"campfin\")`."        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [98] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [99] "```{r campfin-version}"                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [100] "packageVersion(\"campfin\")"                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [101] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [102] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [103] "```{r package-options, echo=FALSE}"                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [104] "options(options(knitr.kable.NA = \"\"))"                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [105] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [106] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [107] "This document should be run as part of the `R_tap` project, which lives as a"       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [108] "sub-directory of the more general, language-agnostic"                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [109] "[`irworkshop/accountability_datacleaning`][tap] GitHub repository."                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [110] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [111] "The `R_tap` project uses the [RStudio projects][rproj] feature and should be"       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [112] "run as such. The project also uses the dynamic `here::here()` tool for file"        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [113] "paths relative to _your_ machine."                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [114] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [115] "```{r where-here}"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [116] "# where does this document knit?"                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [117] "here::i_am(\"state/vt/contribs/docs/vt_contribs_diary.Rmd\")"                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [118] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [119] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [120] "[tap]: https://github.com/irworkshop/accountability_datacleaning"                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [121] "[rproj]: https://support.rstudio.com/hc/en-us/articles/200526207-Using-Projects"    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [122] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [123] "## Source"                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [124] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [125] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [126] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [127] "## Download"                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [128] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [129] "```{r raw-dir}"                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [130] "raw_url &lt;- \"https://example.com/source_file.csv\""                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [131] "raw_dir &lt;- dir_create(here(\"state\", \"vt\", \"contribs\", \"data\", \"raw\"))"    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [132] "raw_csv &lt;- path(raw_dir, basename(raw_url))"                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [133] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [134] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [135] "```{r raw-download}"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [136] "if (!file_exists(raw_csv)) {"                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [137] "  download.file(raw_url, raw_csv)"                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [138] "}"                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [139] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [140] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [141] "## Read"                                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [142] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [143] "```{r raw-read}"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [144] "vtc &lt;- read_delim("                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [145] "  file = raw_csv,"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [146] "  delim = \",\","                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [147] "  escape_backslash = FALSE,"                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [148] "  escape_double = FALSE,"                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [149] "  col_types = cols("                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [150] "    .default = col_character(),"                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [151] "    date = col_date_mdy(),"                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [152] "    amount = col_double()"                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [153] "  )"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [154] ")"                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [155] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [156] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [157] "```{r clean-names}"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [158] "vtc &lt;- clean_names(vtc, case = \"snake\")"                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [159] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [160] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [161] "## Explore"                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [162] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [163] "There are `r comma(nrow(vtc))` rows of `r ncol(vtc)` columns. Each record"          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [164] "represents a single Contributions..."                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [165] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [166] "```{r glimpse}"                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [167] "glimpse(vtc)"                                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [168] "tail(vtc)"                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [169] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [170] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [171] "### Missing"                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [172] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [173] "Columns vary in their degree of missing values."                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [174] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [175] "```{r na-count}"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [176] "col_stats(vtc, count_na)"                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [177] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [178] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [179] "We can flag any record missing a key variable needed to identify a transaction."    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [180] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [181] "```{r na-flag}"                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [182] "key_vars &lt;- c(\"date\", \"last_name\", \"amount\", \"committee_name\")"             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [183] "vtc &lt;- flag_na(vtc, all_of(key_vars))"                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [184] "sum(vtc$na_flag)"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [185] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [186] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [187] "```{r na-view}"                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [188] "vtc %&gt;% "                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [189] "  filter(na_flag) %&gt;% "                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [190] "  select(all_of(key_vars))"                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [191] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [192] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [193] "### Duplicates"                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [194] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [195] "We can also flag any record completely duplicated across every column."             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [196] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [197] "```{r dupe-flag}"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [198] "vtc &lt;- flag_dupes(vtc, -id)"                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [199] "sum(vtc$dupe_flag)"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [200] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [201] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [202] "```{r dupe-view}"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [203] "vtc %&gt;% "                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [204] "  filter(dupe_flag) %&gt;% "                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [205] "  select(all_of(key_vars)) %&gt;% "                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [206] "  arrange(date)"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [207] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [208] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [209] "### Categorical"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [210] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [211] "```{r distinct-count}"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [212] "col_stats(vtc, n_distinct)"                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [213] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [214] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [215] "```{r distinct-plots, echo=FALSE, fig.height=3}"                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [216] "explore_plot(vtc, type)"                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [217] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [218] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [219] "### Amounts"                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [220] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [221] "```{r amount-round}"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [222] "# fix floating point precision"                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [223] "vtc$amount &lt;- round(vtc$amount, digits = 2)"                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [224] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [225] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [226] "```{r amount-summary}"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [227] "summary(vtc$amount)"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [228] "mean(vtc$amount &lt;= 0)"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [229] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [230] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [231] "These are the records with the minimum and maximum amounts."                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [232] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [233] "```{r amount-minmax}"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [234] "glimpse(vtc[c(which.max(vtc$amount), which.min(vtc$amount)), ])"                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [235] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [236] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [237] "The distribution of amount values are typically log-normal."                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [238] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [239] "```{r hist-amount, echo=FALSE}"                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [240] "vtc %&gt;%"                                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [241] "  ggplot(aes(amount)) +"                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [242] "  geom_histogram(fill = dark2[\"purple\"]) +"                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [243] "  scale_y_continuous(labels = comma) +"                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [244] "  scale_x_continuous("                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [245] "    breaks = c(1 %o% 10^(0:6)),"                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [246] "    labels = dollar,"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [247] "    trans = \"log10\""                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [248] "  ) +"                                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [249] "  labs("                                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [250] "    title = \"Vermont Contributions Amount Distribution\","                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [251] "    caption = \"Source: {source}\","                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [252] "    x = \"Amount\","                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [253] "    y = \"Count\""                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [254] "  )"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [255] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [256] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [257] "### Dates"                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [258] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [259] "We can add the calendar year from `date` with `lubridate::year()`"                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [260] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [261] "```{r date-year}"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [262] "vtc &lt;- mutate(vtc, year = year(date))"                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [263] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [264] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [265] "```{r date-range}"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [266] "min(vtc$date)"                                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [267] "sum(vtc$year &lt; 2000)"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [268] "max(vtc$date)"                                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [269] "sum(vtc$date &gt; today())"                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [270] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [271] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [272] "It's common to see an increase in the number of contributins in elections years."   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [273] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [274] "```{r bar-year, echo=FALSE}"                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [275] "vtc %&gt;% "                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [276] "  count(year) %&gt;% "                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [277] "  mutate(even = is_even(year)) %&gt;% "                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [278] "  ggplot(aes(x = year, y = n)) +"                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [279] "  geom_col(aes(fill = even)) + "                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [280] "  scale_fill_brewer(palette = \"Dark2\") +"                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [281] "  scale_y_continuous(labels = comma) +"                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [282] "  scale_x_continuous(breaks = seq(2000, 2020, by = 2)) +"                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [283] "  theme(legend.position = \"bottom\") +"                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [284] "  labs("                                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [285] "    title = \"Vermont Contributions by Year\","                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [286] "    caption = \"Source: {source}\","                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [287] "    fill = \"Election Year\","                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [288] "    x = \"Year Made\","                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [289] "    y = \"Count\""                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [290] "  )"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [291] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [292] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [293] "## Wrangle"                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [294] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [295] "To improve the searchability of the database, we will perform some consistent,"     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [296] "confident string normalization. For geographic variables like city names and"       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [297] "ZIP codes, the corresponding `campfin::normal_*()` functions are tailor made to "   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [298] "facilitate this process."                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [299] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [300] "### Address"                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [301] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [302] "For the street `addresss` variable, the `campfin::normal_address()` function"       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [303] "will force consistence case, remove punctuation, and abbreviate official "          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [304] "USPS suffixes."                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [305] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [306] "```{r address-norm}"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [307] "addr_norm &lt;- vtc %&gt;% "                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [308] "  distinct(address1, address2) %&gt;% "                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [309] "  unite("                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [310] "    col = address_full,"                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [311] "    starts_with(\"address\"),"                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [312] "    sep = \" \","                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [313] "    remove = FALSE,"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [314] "    na.rm = TRUE"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [315] "  ) %&gt;% "                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [316] "  mutate("                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [317] "    address_norm = normal_address("                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [318] "      address = address_full,"                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [319] "      abbs = usps_street,"                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [320] "      na_rep = TRUE"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [321] "    )"                                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [322] "  ) %&gt;% "                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [323] "  select(-address_full)"                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [324] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [325] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [326] "```{r address-view}"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [327] "addr_norm"                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [328] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [329] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [330] "```{r address-join}"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [331] "vtc &lt;- left_join(vtc, addr_norm, by = c(\"address1\", \"address2\"))"               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [332] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [333] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [334] "### ZIP"                                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [335] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [336] "For ZIP codes, the `campfin::normal_zip()` function will attempt to create"         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [337] "valid _five_ digit codes by removing the ZIP+4 suffix and returning leading"        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [338] "zeroes dropped by other programs like Microsoft Excel."                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [339] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [340] "```{r zip-norm}"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [341] "vtc &lt;- vtc %&gt;% "                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [342] "  mutate("                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [343] "    zip_norm = normal_zip("                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [344] "      zip = zip,"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [345] "      na_rep = TRUE"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [346] "    )"                                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [347] "  )"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [348] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [349] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [350] "```{r zip-progress}"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [351] "progress_table("                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [352] "  vtc$zip,"                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [353] "  vtc$zip_norm,"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [354] "  compare = valid_zip"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [355] ")"                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [356] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [357] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [358] "### State"                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [359] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [360] "Valid two digit state abbreviations can be made using the "                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [361] "`campfin::normal_state()` function."                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [362] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [363] "```{r state-norm}"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [364] "vtc &lt;- vtc %&gt;% "                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [365] "  mutate("                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [366] "    state_norm = normal_state("                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [367] "      state = state,"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [368] "      abbreviate = TRUE,"                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [369] "      na_rep = TRUE,"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [370] "      valid = valid_state"                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [371] "    )"                                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [372] "  )"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [373] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [374] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [375] "```{r state-view}"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [376] "vtc %&gt;% "                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [377] "  filter(state != state_norm) %&gt;% "                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [378] "  count(state, state_norm, sort = TRUE)"                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [379] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [380] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [381] "```{r state-progress}"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [382] "progress_table("                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [383] "  vtc$state,"                                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [384] "  vtc$state_norm,"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [385] "  compare = valid_state"                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [386] ")"                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [387] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [388] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [389] "### City"                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [390] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [391] "Cities are the most difficult geographic variable to normalize, simply due to"      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [392] "the wide variety of valid cities and formats."                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [393] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [394] "#### Normal"                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [395] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [396] "The `campfin::normal_city()` function is a good start, again converting case,"      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [397] "removing punctuation, but _expanding_ USPS abbreviations. We can also remove"       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [398] "`invalid_city` values."                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [399] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [400] "```{r city-norm}"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [401] "norm_city &lt;- vtc %&gt;% "                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [402] "  distinct(city, state_norm, zip_norm) %&gt;% "                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [403] "  mutate("                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [404] "    city_norm = normal_city("                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [405] "      city = city, "                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [406] "      abbs = usps_city,"                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [407] "      states = c(\"VT\", \"DC\", \"VERMONT\"),"                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [408] "      na = invalid_city,"                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [409] "      na_rep = TRUE"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [410] "    )"                                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [411] "  )"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [412] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [413] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [414] "#### Swap"                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [415] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [416] "We can further improve normalization by comparing our normalized value"             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [417] "against the _expected_ value for that record's state abbreviation and ZIP code."    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [418] "If the normalized value is either an abbreviation for or very similar to the"       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [419] "expected value, we can confidently swap those two."                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [420] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [421] "```{r city-swap}"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [422] "norm_city &lt;- norm_city %&gt;% "                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [423] "  rename(city_raw = city) %&gt;% "                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [424] "  left_join("                                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [425] "    y = zipcodes,"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [426] "    by = c("                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [427] "      \"state_norm\" = \"state\","                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [428] "      \"zip_norm\" = \"zip\""                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [429] "    )"                                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [430] "  ) %&gt;% "                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [431] "  rename(city_match = city) %&gt;% "                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [432] "  mutate("                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [433] "    match_abb = is_abbrev(city_norm, city_match),"                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [434] "    match_dist = str_dist(city_norm, city_match),"                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [435] "    city_swap = if_else("                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [436] "      condition = !is.na(match_dist) &amp; (match_abb | match_dist == 1),"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [437] "      true = city_match,"                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [438] "      false = city_norm"                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [439] "    )"                                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [440] "  ) %&gt;% "                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [441] "  select("                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [442] "    -city_match,"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [443] "    -match_dist,"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [444] "    -match_abb"                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [445] "  )"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [446] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [447] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [448] "```{r city-rejoin}"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [449] "vtc &lt;- left_join("                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [450] "  x = vtc,"                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [451] "  y = norm_city,"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [452] "  by = c("                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [453] "    \"city\" = \"city_raw\", "                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [454] "    \"state_norm\", "                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [455] "    \"zip_norm\""                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [456] "  )"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [457] ")"                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [458] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [459] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [460] "#### Refine"                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [461] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [462] "The [OpenRefine][or] algorithms can be used to group similar strings and replace"   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [463] "the less common versions with their most common counterpart. This can greatly"      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [464] "reduce inconsistency, but with low confidence; we will only keep any refined"       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [465] "strings that have a valid city/state/zip combination."                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [466] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [467] "[or]: https://openrefine.org/"                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [468] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [469] "```{r city-refine}"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [470] "good_refine &lt;- vtc %&gt;% "                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [471] "  mutate("                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [472] "    city_refine = city_swap %&gt;% "                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [473] "      key_collision_merge() %&gt;% "                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [474] "      n_gram_merge(numgram = 1)"                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [475] "  ) %&gt;% "                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [476] "  filter(city_refine != city_swap) %&gt;% "                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [477] "  inner_join("                                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [478] "    y = zipcodes,"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [479] "    by = c("                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [480] "      \"city_refine\" = \"city\","                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [481] "      \"state_norm\" = \"state\","                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [482] "      \"zip_norm\" = \"zip\""                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [483] "    )"                                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [484] "  )"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [485] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [486] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [487] "```{r city-count, echo=FALSE}"                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [488] "good_refine %&gt;%"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [489] "  count("                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [490] "    state_norm, "                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [491] "    zip_norm, "                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [492] "    city_swap, "                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [493] "    city_refine,"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [494] "    sort = TRUE"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [495] "  )"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [496] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [497] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [498] "Then we can join the refined values back to the database."                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [499] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [500] "```{r city-join}"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [501] "vtc &lt;- vtc %&gt;% "                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [502] "  left_join(good_refine, by = names(.)) %&gt;% "                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [503] "  mutate(city_refine = coalesce(city_refine, city_swap))"                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [504] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [505] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [506] "#### Progress"                                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [507] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [508] "Our goal for normalization was to increase the proportion of city values known"     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [509] "to be valid and reduce the total distinct values by correcting misspellings."       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [510] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [511] "```{r city-progress, echo=FALSE}"                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [512] "many_city &lt;- c(valid_city, extra_city)"                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [513] "progress &lt;- progress_table("                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [514] "  str_to_upper(vtc$city),"                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [515] "  vtc$city_norm,"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [516] "  vtc$city_swap,"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [517] "  vtc$city_refine,"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [518] "  compare = many_city"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [519] ") %&gt;% mutate(stage = as_factor(stage))"                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [520] "progress %&gt;% "                                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [521] "    mutate(across(stage, md_code)) %&gt;% "                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [522] "    kable(digits = 3)"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [523] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [524] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [525] "You can see how the percentage of valid values increased with each stage."          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [526] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [527] "```{r bar-progress, echo=FALSE}"                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [528] "raw_in &lt;- percent(prop_in(vtc$city, valid_city))"                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [529] "progress %&gt;% "                                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [530] "  ggplot(aes(x = stage, y = prop_in)) +"                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [531] "  geom_hline(yintercept = 0.99) +"                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [532] "  geom_col(fill = dark2[\"purple\"]) +"                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [533] "  coord_cartesian(ylim = c(0.75, 1)) +"                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [534] "  scale_y_continuous(labels = percent) +"                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [535] "  labs("                                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [536] "    title = \"Vermont City Normalization Progress\","                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [537] "    subtitle = glue(\"Raw at {raw_in} before conversion to uppercase\"),"           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [538] "    x = \"Stage\","                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [539] "    y = \"Percent Valid\""                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [540] "  )"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [541] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [542] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [543] "More importantly, the number of distinct values decreased each stage. We were"      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [544] "able to confidently change many distinct invalid values to their valid"             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [545] "equivalent."                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [546] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [547] "```{r bar-distinct, echo=FALSE}"                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [548] "progress %&gt;% "                                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [549] "  select("                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [550] "    stage, "                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [551] "    all = n_distinct,"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [552] "    bad = n_diff"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [553] "  ) %&gt;% "                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [554] "  mutate(good = all - bad) %&gt;% "                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [555] "  pivot_longer(c(\"good\", \"bad\")) %&gt;% "                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [556] "  mutate(name = name == \"good\") %&gt;% "                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [557] "  ggplot(aes(x = stage, y = value)) +"                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [558] "  geom_col(aes(fill = name)) +"                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [559] "  scale_fill_brewer(palette = \"Dark2\", direction = -1) +"                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [560] "  scale_y_continuous(labels = comma) +"                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [561] "  theme(legend.position = \"bottom\") +"                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [562] "  labs("                                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [563] "    title = \"Vermont City Normalization Progress\","                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [564] "    subtitle = \"Distinct values, valid and invalid\","                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [565] "    x = \"Stage\","                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [566] "    y = \"Distinct Values\","                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [567] "    fill = \"Valid\""                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [568] "  )"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [569] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [570] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [571] "Before exporting, we can remove the intermediary normalization columns and"         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [572] "rename all added variables with the `_clean` suffix."                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [573] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [574] "```{r clean-select}"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [575] "vtc &lt;- vtc %&gt;% "                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [576] "  select("                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [577] "    -city_norm,"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [578] "    -city_swap,"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [579] "    city_clean = city_refine"                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [580] "  ) %&gt;% "                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [581] "  rename_all(~str_replace(., \"_norm\", \"_clean\")) %&gt;% "                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [582] "  rename_all(~str_remove(., \"_raw\")) %&gt;% "                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [583] "  relocate(address_clean, city_clean, state_clean, .before = zip_clean)"            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [584] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [585] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [586] "## Conclude"                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [587] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [588] "```{r clean-glimpse}"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [589] "glimpse(sample_n(vtc, 1000))"                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [590] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [591] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [592] "1. There are `r comma(nrow(vtc))` records in the database."                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [593] "1. There are `r comma(sum(vtc$dupe_flag))` duplicate records in the database."      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [594] "1. The range and distribution of `amount` and `date` seem reasonable."              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [595] "1. There are `r comma(sum(vtc$na_flag))` records missing key variables."            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [596] "1. Consistency in geographic data has been improved with `campfin::normal_*()`."    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [597] "1. The 4-digit `year` variable has been created with `lubridate::year()`."          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [598] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [599] "## Export"                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [600] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [601] "Now the file can be saved on disk for upload to the Accountability server. We"      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [602] "will name the object using a date range of the records included."                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [603] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [604] "```{r clean-timestamp}"                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [605] "min_dt &lt;- str_remove_all(min(vtc$date), \"-\")"                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [606] "max_dt &lt;- str_remove_all(max(vtc$date), \"-\")"                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [607] "csv_ts &lt;- paste(min_dt, max_dt, sep = \"-\")"                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [608] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [609] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [610] "```{r clean-dir}"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [611] "clean_dir &lt;- dir_create(here(\"state\", \"vt\", \"contribs\", \"data\", \"clean\"))"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [612] "clean_csv &lt;- path(clean_dir, glue(\"vt_contribs_{csv_ts}.csv\"))"                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [613] "clean_rds &lt;- path_ext_set(clean_csv, \"rds\")"                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [614] "basename(clean_csv)"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [615] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [616] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [617] "```{r clean-write}"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [618] "write_csv(vtc, clean_csv, na = \"\")"                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [619] "write_rds(vtc, clean_rds, compress = \"xz\")"                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [620] "(clean_size &lt;- file_size(clean_csv))"                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [621] "```"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [622] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [623] "## Upload"                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [624] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [625] "We can use the `aws.s3::put_object()` to upload the text file to the IRW server."   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [626] ""                                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [627] "```{r aws-upload, eval=FALSE}"                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [628] "aws_key &lt;- path(\"csv\", basename(clean_csv))"                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [629] "if (!object_exists(aws_key, \"publicaccountability\")) {"                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [630] "  put_object("                                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [631] "    file = clean_csv,"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [632] "    object = aws_key, "                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [633] "    bucket = \"publicaccountability\","                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [634] "    acl = \"public-read\","                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [635] "    show_progress = TRUE,"                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [636] "    multipart = TRUE"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [637] "  )"                                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [638] "}"                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [639] "aws_head &lt;- head_object(aws_key, \"publicaccountability\")"                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [640] "(aws_size &lt;- as_fs_bytes(attr(aws_head, \"content-length\")))"                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [641] "unname(aws_size == clean_size)"                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [642] "```"                                                                                </span>
<span class="r-in"><span><span class="fu">use_diary</span><span class="op">(</span><span class="st">"DC"</span>, <span class="st">"expends"</span>, <span class="st">"Kiernan Nicholls"</span>, <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span>, auto <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [1] "---"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [2] "title: \"District Of Columbia Expenditures\""                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [3] "author: \"Kiernan Nicholls\""                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [4] "date: \"`r date()`\""                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [5] "output:"                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [6] "  github_document: "                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [7] "    df_print: tibble"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [8] "    toc: true"                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [9] "    toc_dept: 3"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [10] "editor_options: "                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [11] "  chunk_output_type: console"                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [12] "---"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [13] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [14] "&lt;!-- Place comments regarding knitting here --&gt;"                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [15] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [16] "```{r setup, include=FALSE, purl=FALSE}"                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [17] "library(knitr)"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [18] "opts_chunk$set("                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [19] "  eval = TRUE,"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [20] "  echo = TRUE,"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [21] "  warning = FALSE,"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [22] "  message = FALSE,"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [23] "  error = FALSE,"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [24] "  collapse = TRUE,"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [25] "  comment = \"#&gt;\","                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [26] "  fig.path = \"../plots/\","                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [27] "  fig.width = 10,"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [28] "  dpi = 300"                                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [29] ")"                                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [30] "if (!interactive()) {"                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [31] "  options(width = 120)"                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [32] "  set.seed(5)"                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [33] "}"                                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [34] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [35] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [36] "```{r create-docs-dir, eval=FALSE, echo=FALSE, include=FALSE}"                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [37] "doc_dir &lt;- fs::dir_create(here::here(\"state\", \"dc\", \"expends\", \"docs\"))"   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [38] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [39] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [40] "## Project"                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [41] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [42] "The Accountability Project is an effort to cut across data silos and give"         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [43] "journalists, policy professionals, activists, and the public at large a simple"    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [44] "way to search across huge volumes of public data about people and organizations."  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [45] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [46] "Our goal is to standardize public data on a few key fields by thinking of each"    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [47] "dataset row as a transaction. For each transaction there should be (at least) 3"   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [48] "variables:"                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [49] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [50] "1. All **parties** to a transaction."                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [51] "2. The **date** of the transaction."                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [52] "3. The **amount** of money involved."                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [53] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [54] "## Objectives"                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [55] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [56] "This document describes the process used to complete the following objectives:"    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [57] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [58] "1. How many records are in the database?"                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [59] "1. Check for entirely duplicated records."                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [60] "1. Check ranges of continuous variables."                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [61] "1. Is there anything blank or missing?"                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [62] "1. Check for consistency issues."                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [63] "1. Create a five-digit ZIP Code called `zip`."                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [64] "1. Create a `year` field from the transaction date."                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [65] "1. Make sure there is data on both parties to a transaction."                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [66] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [67] "## Packages"                                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [68] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [69] "The following packages are needed to collect, manipulate, visualize, analyze,"     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [70] "and communicate these results. The `pacman` package will facilitate their"         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [71] "installation and attachment."                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [72] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [73] "```{r load-packages, message=FALSE, warning=FALSE, error=FALSE}"                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [74] "if (!require(\"pacman\")) {"                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [75] "  install.packages(\"pacman\")"                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [76] "}"                                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [77] "pacman::p_load("                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [78] "  tidyverse, # data manipulation"                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [79] "  lubridate, # datetime strings"                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [80] "  gluedown, # printing markdown"                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [81] "  jsonlite, # read json files"                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [82] "  janitor, # clean data frames"                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [83] "  campfin, # custom irw tools"                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [84] "  aws.s3, # aws cloud storage"                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [85] "  readxl, # read excel files"                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [86] "  refinr, # cluster &amp; merge"                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [87] "  scales, # format strings"                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [88] "  knitr, # knit documents"                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [89] "  rvest, # scrape html"                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [90] "  glue, # code strings"                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [91] "  here, # project paths"                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [92] "  httr, # http requests"                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [93] "  fs # local storage "                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [94] ")"                                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [95] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [96] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [97] "This diary was run using `campfin` version `r packageVersion(\"campfin\")`."       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [98] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [99] "```{r campfin-version}"                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [100] "packageVersion(\"campfin\")"                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [101] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [102] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [103] "```{r package-options, echo=FALSE}"                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [104] "options(options(knitr.kable.NA = \"\"))"                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [105] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [106] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [107] "This document should be run as part of the `R_tap` project, which lives as a"      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [108] "sub-directory of the more general, language-agnostic"                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [109] "[`irworkshop/accountability_datacleaning`][tap] GitHub repository."                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [110] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [111] "The `R_tap` project uses the [RStudio projects][rproj] feature and should be"      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [112] "run as such. The project also uses the dynamic `here::here()` tool for file"       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [113] "paths relative to _your_ machine."                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [114] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [115] "```{r where-here}"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [116] "# where does this document knit?"                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [117] "here::i_am(\"state/dc/expends/docs/dc_expends_diary.Rmd\")"                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [118] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [119] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [120] "[tap]: https://github.com/irworkshop/accountability_datacleaning"                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [121] "[rproj]: https://support.rstudio.com/hc/en-us/articles/200526207-Using-Projects"   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [122] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [123] "## Source"                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [124] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [125] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [126] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [127] "## Download"                                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [128] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [129] "```{r raw-dir}"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [130] "raw_url &lt;- \"https://example.com/source_file.csv\""                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [131] "raw_dir &lt;- dir_create(here(\"state\", \"dc\", \"expends\", \"data\", \"raw\"))"    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [132] "raw_csv &lt;- path(raw_dir, basename(raw_url))"                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [133] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [134] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [135] "```{r raw-download}"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [136] "if (!file_exists(raw_csv)) {"                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [137] "  download.file(raw_url, raw_csv)"                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [138] "}"                                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [139] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [140] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [141] "## Read"                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [142] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [143] "```{r raw-read}"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [144] "dce &lt;- read_delim("                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [145] "  file = raw_csv,"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [146] "  delim = \",\","                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [147] "  escape_backslash = FALSE,"                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [148] "  escape_double = FALSE,"                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [149] "  col_types = cols("                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [150] "    .default = col_character(),"                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [151] "    date = col_date_mdy(),"                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [152] "    amount = col_double()"                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [153] "  )"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [154] ")"                                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [155] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [156] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [157] "```{r clean-names}"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [158] "dce &lt;- clean_names(dce, case = \"snake\")"                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [159] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [160] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [161] "## Explore"                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [162] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [163] "There are `r comma(nrow(dce))` rows of `r ncol(dce)` columns. Each record"         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [164] "represents a single Expenditures..."                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [165] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [166] "```{r glimpse}"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [167] "glimpse(dce)"                                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [168] "tail(dce)"                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [169] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [170] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [171] "### Missing"                                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [172] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [173] "Columns vary in their degree of missing values."                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [174] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [175] "```{r na-count}"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [176] "col_stats(dce, count_na)"                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [177] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [178] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [179] "We can flag any record missing a key variable needed to identify a transaction."   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [180] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [181] "```{r na-flag}"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [182] "key_vars &lt;- c(\"date\", \"last_name\", \"amount\", \"committee_name\")"            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [183] "dce &lt;- flag_na(dce, all_of(key_vars))"                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [184] "sum(dce$na_flag)"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [185] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [186] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [187] "```{r na-view}"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [188] "dce %&gt;% "                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [189] "  filter(na_flag) %&gt;% "                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [190] "  select(all_of(key_vars))"                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [191] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [192] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [193] "### Duplicates"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [194] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [195] "We can also flag any record completely duplicated across every column."            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [196] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [197] "```{r dupe-flag}"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [198] "dce &lt;- flag_dupes(dce, -id)"                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [199] "sum(dce$dupe_flag)"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [200] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [201] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [202] "```{r dupe-view}"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [203] "dce %&gt;% "                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [204] "  filter(dupe_flag) %&gt;% "                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [205] "  select(all_of(key_vars)) %&gt;% "                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [206] "  arrange(date)"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [207] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [208] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [209] "### Categorical"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [210] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [211] "```{r distinct-count}"                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [212] "col_stats(dce, n_distinct)"                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [213] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [214] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [215] "```{r distinct-plots, echo=FALSE, fig.height=3}"                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [216] "explore_plot(dce, type)"                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [217] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [218] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [219] "### Amounts"                                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [220] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [221] "```{r amount-round}"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [222] "# fix floating point precision"                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [223] "dce$amount &lt;- round(dce$amount, digits = 2)"                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [224] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [225] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [226] "```{r amount-summary}"                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [227] "summary(dce$amount)"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [228] "mean(dce$amount &lt;= 0)"                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [229] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [230] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [231] "These are the records with the minimum and maximum amounts."                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [232] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [233] "```{r amount-minmax}"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [234] "glimpse(dce[c(which.max(dce$amount), which.min(dce$amount)), ])"                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [235] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [236] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [237] "The distribution of amount values are typically log-normal."                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [238] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [239] "```{r hist-amount, echo=FALSE}"                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [240] "dce %&gt;%"                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [241] "  ggplot(aes(amount)) +"                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [242] "  geom_histogram(fill = dark2[\"purple\"]) +"                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [243] "  scale_y_continuous(labels = comma) +"                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [244] "  scale_x_continuous("                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [245] "    breaks = c(1 %o% 10^(0:6)),"                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [246] "    labels = dollar,"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [247] "    trans = \"log10\""                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [248] "  ) +"                                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [249] "  labs("                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [250] "    title = \"District Of Columbia Expenditures Amount Distribution\","            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [251] "    caption = \"Source: {source}\","                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [252] "    x = \"Amount\","                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [253] "    y = \"Count\""                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [254] "  )"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [255] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [256] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [257] "### Dates"                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [258] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [259] "We can add the calendar year from `date` with `lubridate::year()`"                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [260] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [261] "```{r date-year}"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [262] "dce &lt;- mutate(dce, year = year(date))"                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [263] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [264] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [265] "```{r date-range}"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [266] "min(dce$date)"                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [267] "sum(dce$year &lt; 2000)"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [268] "max(dce$date)"                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [269] "sum(dce$date &gt; today())"                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [270] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [271] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [272] "It's common to see an increase in the number of contributins in elections years."  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [273] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [274] "```{r bar-year, echo=FALSE}"                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [275] "dce %&gt;% "                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [276] "  count(year) %&gt;% "                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [277] "  mutate(even = is_even(year)) %&gt;% "                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [278] "  ggplot(aes(x = year, y = n)) +"                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [279] "  geom_col(aes(fill = even)) + "                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [280] "  scale_fill_brewer(palette = \"Dark2\") +"                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [281] "  scale_y_continuous(labels = comma) +"                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [282] "  scale_x_continuous(breaks = seq(2000, 2020, by = 2)) +"                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [283] "  theme(legend.position = \"bottom\") +"                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [284] "  labs("                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [285] "    title = \"District Of Columbia Expenditures by Year\","                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [286] "    caption = \"Source: {source}\","                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [287] "    fill = \"Election Year\","                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [288] "    x = \"Year Made\","                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [289] "    y = \"Count\""                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [290] "  )"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [291] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [292] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [293] "## Wrangle"                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [294] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [295] "To improve the searchability of the database, we will perform some consistent,"    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [296] "confident string normalization. For geographic variables like city names and"      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [297] "ZIP codes, the corresponding `campfin::normal_*()` functions are tailor made to "  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [298] "facilitate this process."                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [299] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [300] "### Address"                                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [301] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [302] "For the street `addresss` variable, the `campfin::normal_address()` function"      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [303] "will force consistence case, remove punctuation, and abbreviate official "         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [304] "USPS suffixes."                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [305] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [306] "```{r address-norm}"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [307] "addr_norm &lt;- dce %&gt;% "                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [308] "  distinct(address1, address2) %&gt;% "                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [309] "  unite("                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [310] "    col = address_full,"                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [311] "    starts_with(\"address\"),"                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [312] "    sep = \" \","                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [313] "    remove = FALSE,"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [314] "    na.rm = TRUE"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [315] "  ) %&gt;% "                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [316] "  mutate("                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [317] "    address_norm = normal_address("                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [318] "      address = address_full,"                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [319] "      abbs = usps_street,"                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [320] "      na_rep = TRUE"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [321] "    )"                                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [322] "  ) %&gt;% "                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [323] "  select(-address_full)"                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [324] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [325] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [326] "```{r address-view}"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [327] "addr_norm"                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [328] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [329] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [330] "```{r address-join}"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [331] "dce &lt;- left_join(dce, addr_norm, by = c(\"address1\", \"address2\"))"              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [332] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [333] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [334] "### ZIP"                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [335] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [336] "For ZIP codes, the `campfin::normal_zip()` function will attempt to create"        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [337] "valid _five_ digit codes by removing the ZIP+4 suffix and returning leading"       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [338] "zeroes dropped by other programs like Microsoft Excel."                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [339] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [340] "```{r zip-norm}"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [341] "dce &lt;- dce %&gt;% "                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [342] "  mutate("                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [343] "    zip_norm = normal_zip("                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [344] "      zip = zip,"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [345] "      na_rep = TRUE"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [346] "    )"                                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [347] "  )"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [348] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [349] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [350] "```{r zip-progress}"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [351] "progress_table("                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [352] "  dce$zip,"                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [353] "  dce$zip_norm,"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [354] "  compare = valid_zip"                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [355] ")"                                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [356] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [357] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [358] "### State"                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [359] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [360] "Valid two digit state abbreviations can be made using the "                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [361] "`campfin::normal_state()` function."                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [362] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [363] "```{r state-norm}"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [364] "dce &lt;- dce %&gt;% "                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [365] "  mutate("                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [366] "    state_norm = normal_state("                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [367] "      state = state,"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [368] "      abbreviate = TRUE,"                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [369] "      na_rep = TRUE,"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [370] "      valid = valid_state"                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [371] "    )"                                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [372] "  )"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [373] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [374] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [375] "```{r state-view}"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [376] "dce %&gt;% "                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [377] "  filter(state != state_norm) %&gt;% "                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [378] "  count(state, state_norm, sort = TRUE)"                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [379] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [380] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [381] "```{r state-progress}"                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [382] "progress_table("                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [383] "  dce$state,"                                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [384] "  dce$state_norm,"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [385] "  compare = valid_state"                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [386] ")"                                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [387] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [388] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [389] "### City"                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [390] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [391] "Cities are the most difficult geographic variable to normalize, simply due to"     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [392] "the wide variety of valid cities and formats."                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [393] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [394] "#### Normal"                                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [395] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [396] "The `campfin::normal_city()` function is a good start, again converting case,"     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [397] "removing punctuation, but _expanding_ USPS abbreviations. We can also remove"      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [398] "`invalid_city` values."                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [399] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [400] "```{r city-norm}"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [401] "norm_city &lt;- dce %&gt;% "                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [402] "  distinct(city, state_norm, zip_norm) %&gt;% "                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [403] "  mutate("                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [404] "    city_norm = normal_city("                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [405] "      city = city, "                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [406] "      abbs = usps_city,"                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [407] "      states = c(\"DC\", \"DC\", \"DISTRICT OF COLUMBIA\"),"                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [408] "      na = invalid_city,"                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [409] "      na_rep = TRUE"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [410] "    )"                                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [411] "  )"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [412] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [413] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [414] "#### Swap"                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [415] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [416] "We can further improve normalization by comparing our normalized value"            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [417] "against the _expected_ value for that record's state abbreviation and ZIP code."   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [418] "If the normalized value is either an abbreviation for or very similar to the"      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [419] "expected value, we can confidently swap those two."                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [420] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [421] "```{r city-swap}"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [422] "norm_city &lt;- norm_city %&gt;% "                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [423] "  rename(city_raw = city) %&gt;% "                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [424] "  left_join("                                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [425] "    y = zipcodes,"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [426] "    by = c("                                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [427] "      \"state_norm\" = \"state\","                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [428] "      \"zip_norm\" = \"zip\""                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [429] "    )"                                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [430] "  ) %&gt;% "                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [431] "  rename(city_match = city) %&gt;% "                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [432] "  mutate("                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [433] "    match_abb = is_abbrev(city_norm, city_match),"                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [434] "    match_dist = str_dist(city_norm, city_match),"                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [435] "    city_swap = if_else("                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [436] "      condition = !is.na(match_dist) &amp; (match_abb | match_dist == 1),"             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [437] "      true = city_match,"                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [438] "      false = city_norm"                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [439] "    )"                                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [440] "  ) %&gt;% "                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [441] "  select("                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [442] "    -city_match,"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [443] "    -match_dist,"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [444] "    -match_abb"                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [445] "  )"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [446] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [447] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [448] "```{r city-rejoin}"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [449] "dce &lt;- left_join("                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [450] "  x = dce,"                                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [451] "  y = norm_city,"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [452] "  by = c("                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [453] "    \"city\" = \"city_raw\", "                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [454] "    \"state_norm\", "                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [455] "    \"zip_norm\""                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [456] "  )"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [457] ")"                                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [458] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [459] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [460] "#### Refine"                                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [461] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [462] "The [OpenRefine][or] algorithms can be used to group similar strings and replace"  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [463] "the less common versions with their most common counterpart. This can greatly"     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [464] "reduce inconsistency, but with low confidence; we will only keep any refined"      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [465] "strings that have a valid city/state/zip combination."                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [466] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [467] "[or]: https://openrefine.org/"                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [468] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [469] "```{r city-refine}"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [470] "good_refine &lt;- dce %&gt;% "                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [471] "  mutate("                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [472] "    city_refine = city_swap %&gt;% "                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [473] "      key_collision_merge() %&gt;% "                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [474] "      n_gram_merge(numgram = 1)"                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [475] "  ) %&gt;% "                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [476] "  filter(city_refine != city_swap) %&gt;% "                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [477] "  inner_join("                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [478] "    y = zipcodes,"                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [479] "    by = c("                                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [480] "      \"city_refine\" = \"city\","                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [481] "      \"state_norm\" = \"state\","                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [482] "      \"zip_norm\" = \"zip\""                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [483] "    )"                                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [484] "  )"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [485] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [486] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [487] "```{r city-count, echo=FALSE}"                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [488] "good_refine %&gt;%"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [489] "  count("                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [490] "    state_norm, "                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [491] "    zip_norm, "                                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [492] "    city_swap, "                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [493] "    city_refine,"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [494] "    sort = TRUE"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [495] "  )"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [496] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [497] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [498] "Then we can join the refined values back to the database."                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [499] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [500] "```{r city-join}"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [501] "dce &lt;- dce %&gt;% "                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [502] "  left_join(good_refine, by = names(.)) %&gt;% "                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [503] "  mutate(city_refine = coalesce(city_refine, city_swap))"                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [504] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [505] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [506] "#### Progress"                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [507] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [508] "Our goal for normalization was to increase the proportion of city values known"    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [509] "to be valid and reduce the total distinct values by correcting misspellings."      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [510] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [511] "```{r city-progress, echo=FALSE}"                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [512] "many_city &lt;- c(valid_city, extra_city)"                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [513] "progress &lt;- progress_table("                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [514] "  str_to_upper(dce$city),"                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [515] "  dce$city_norm,"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [516] "  dce$city_swap,"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [517] "  dce$city_refine,"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [518] "  compare = many_city"                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [519] ") %&gt;% mutate(stage = as_factor(stage))"                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [520] "progress %&gt;% "                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [521] "    mutate(across(stage, md_code)) %&gt;% "                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [522] "    kable(digits = 3)"                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [523] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [524] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [525] "You can see how the percentage of valid values increased with each stage."         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [526] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [527] "```{r bar-progress, echo=FALSE}"                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [528] "raw_in &lt;- percent(prop_in(dce$city, valid_city))"                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [529] "progress %&gt;% "                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [530] "  ggplot(aes(x = stage, y = prop_in)) +"                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [531] "  geom_hline(yintercept = 0.99) +"                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [532] "  geom_col(fill = dark2[\"purple\"]) +"                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [533] "  coord_cartesian(ylim = c(0.75, 1)) +"                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [534] "  scale_y_continuous(labels = percent) +"                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [535] "  labs("                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [536] "    title = \"District Of Columbia City Normalization Progress\","                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [537] "    subtitle = glue(\"Raw at {raw_in} before conversion to uppercase\"),"          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [538] "    x = \"Stage\","                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [539] "    y = \"Percent Valid\""                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [540] "  )"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [541] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [542] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [543] "More importantly, the number of distinct values decreased each stage. We were"     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [544] "able to confidently change many distinct invalid values to their valid"            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [545] "equivalent."                                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [546] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [547] "```{r bar-distinct, echo=FALSE}"                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [548] "progress %&gt;% "                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [549] "  select("                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [550] "    stage, "                                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [551] "    all = n_distinct,"                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [552] "    bad = n_diff"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [553] "  ) %&gt;% "                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [554] "  mutate(good = all - bad) %&gt;% "                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [555] "  pivot_longer(c(\"good\", \"bad\")) %&gt;% "                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [556] "  mutate(name = name == \"good\") %&gt;% "                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [557] "  ggplot(aes(x = stage, y = value)) +"                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [558] "  geom_col(aes(fill = name)) +"                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [559] "  scale_fill_brewer(palette = \"Dark2\", direction = -1) +"                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [560] "  scale_y_continuous(labels = comma) +"                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [561] "  theme(legend.position = \"bottom\") +"                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [562] "  labs("                                                                           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [563] "    title = \"District Of Columbia City Normalization Progress\","                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [564] "    subtitle = \"Distinct values, valid and invalid\","                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [565] "    x = \"Stage\","                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [566] "    y = \"Distinct Values\","                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [567] "    fill = \"Valid\""                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [568] "  )"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [569] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [570] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [571] "Before exporting, we can remove the intermediary normalization columns and"        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [572] "rename all added variables with the `_clean` suffix."                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [573] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [574] "```{r clean-select}"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [575] "dce &lt;- dce %&gt;% "                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [576] "  select("                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [577] "    -city_norm,"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [578] "    -city_swap,"                                                                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [579] "    city_clean = city_refine"                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [580] "  ) %&gt;% "                                                                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [581] "  rename_all(~str_replace(., \"_norm\", \"_clean\")) %&gt;% "                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [582] "  rename_all(~str_remove(., \"_raw\")) %&gt;% "                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [583] "  relocate(address_clean, city_clean, state_clean, .before = zip_clean)"           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [584] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [585] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [586] "## Conclude"                                                                       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [587] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [588] "```{r clean-glimpse}"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [589] "glimpse(sample_n(dce, 1000))"                                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [590] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [591] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [592] "1. There are `r comma(nrow(dce))` records in the database."                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [593] "1. There are `r comma(sum(dce$dupe_flag))` duplicate records in the database."     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [594] "1. The range and distribution of `amount` and `date` seem reasonable."             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [595] "1. There are `r comma(sum(dce$na_flag))` records missing key variables."           </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [596] "1. Consistency in geographic data has been improved with `campfin::normal_*()`."   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [597] "1. The 4-digit `year` variable has been created with `lubridate::year()`."         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [598] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [599] "## Export"                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [600] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [601] "Now the file can be saved on disk for upload to the Accountability server. We"     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [602] "will name the object using a date range of the records included."                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [603] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [604] "```{r clean-timestamp}"                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [605] "min_dt &lt;- str_remove_all(min(dce$date), \"-\")"                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [606] "max_dt &lt;- str_remove_all(max(dce$date), \"-\")"                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [607] "csv_ts &lt;- paste(min_dt, max_dt, sep = \"-\")"                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [608] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [609] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [610] "```{r clean-dir}"                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [611] "clean_dir &lt;- dir_create(here(\"state\", \"dc\", \"expends\", \"data\", \"clean\"))"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [612] "clean_csv &lt;- path(clean_dir, glue(\"dc_expends_{csv_ts}.csv\"))"                   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [613] "clean_rds &lt;- path_ext_set(clean_csv, \"rds\")"                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [614] "basename(clean_csv)"                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [615] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [616] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [617] "```{r clean-write}"                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [618] "write_csv(dce, clean_csv, na = \"\")"                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [619] "write_rds(dce, clean_rds, compress = \"xz\")"                                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [620] "(clean_size &lt;- file_size(clean_csv))"                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [621] "```"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [622] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [623] "## Upload"                                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [624] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [625] "We can use the `aws.s3::put_object()` to upload the text file to the IRW server."  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [626] ""                                                                                  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [627] "```{r aws-upload, eval=FALSE}"                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [628] "aws_key &lt;- path(\"csv\", basename(clean_csv))"                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [629] "if (!object_exists(aws_key, \"publicaccountability\")) {"                          </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [630] "  put_object("                                                                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [631] "    file = clean_csv,"                                                             </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [632] "    object = aws_key, "                                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [633] "    bucket = \"publicaccountability\","                                            </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [634] "    acl = \"public-read\","                                                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [635] "    show_progress = TRUE,"                                                         </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [636] "    multipart = TRUE"                                                              </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [637] "  )"                                                                               </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [638] "}"                                                                                 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [639] "aws_head &lt;- head_object(aws_key, \"publicaccountability\")"                        </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [640] "(aws_size &lt;- as_fs_bytes(attr(aws_head, \"content-length\")))"                     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [641] "unname(aws_size == clean_size)"                                                    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [642] "```"                                                                               </span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Kiernan Nicholls, Yanqi Xu.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

